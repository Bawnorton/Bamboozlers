@using Bamboozlers.Classes.AppDbContext
@using Bamboozlers.Classes
@inherits LayoutComponentBase
@inject IDbContextFactory<AppDbContext> Db

<PageTitle>Bamboozlers</PageTitle>
<Layout Sider>
    <LayoutSider>
        <LayoutSiderContent>
            <Bar Mode="BarMode.VerticalInline"
                 CollapseMode="BarCollapseMode.Small"
                 Breakpoint="Breakpoint.Desktop"
                 NavigationBreakpoint="Breakpoint.Tablet"
                 ThemeContrast="ThemeContrast.Dark">
                <BarMenu>
                    <BarItem>
                        <BarLink @onclick="() => ChangeView(View.Friends)">
                            <BarIcon IconName="IconName.UserFriends"></BarIcon>
                            Friends
                        </BarLink>
                    </BarItem>
                    <BarItem>
                        <BarDropdown>
                            <BarDropdownToggle>
                                <BarIcon IconName="IconName.User"></BarIcon>
                                Direct Messages
                            </BarDropdownToggle>
                            <BarDropdownMenu>
                                @foreach (var chat in DmChats)
                                {
                                    <BarItem>
                                        <BarLink @onclick="() => ChangeView(View.Dm, chat.DbReference)">
                                            <BarIcon IconName="IconName.User"></BarIcon>
                                            @chat.User.DisplayName
                                        </BarLink>
                                    </BarItem>
                                }
                            </BarDropdownMenu>
                        </BarDropdown>
                    </BarItem>
                    <BarItem>
                        <BarDropdown>
                            <BarDropdownToggle>
                                <BarIcon IconName="IconName.Users"></BarIcon>
                                Group Chats
                            </BarDropdownToggle>
                            <BarDropdownMenu>
                                @foreach(var chat in GroupChats)
                                {
                                    <BarItem>
                                        <BarLink @onclick="() => ChangeView(View.Group, chat)">
                                            <BarIcon IconName="IconName.Users"></BarIcon>
                                            @chat.Name
                                        </BarLink>
                                    </BarItem>
                                }
                            </BarDropdownMenu>
                        </BarDropdown>
                    </BarItem>
                </BarMenu>
            </Bar>
        </LayoutSiderContent>
    </LayoutSider>
    <Layout>
        <LayoutHeader Fixed>
            @Views[CurrentView].GetViewName()
        </LayoutHeader>
        <LayoutContent>
            @Views[CurrentView]
        </LayoutContent>
    </Layout>
</Layout>

@code {

    private User Self { get; set; }
    
    private List<DmChat> DmChats { get; set; }
    
    private List<GroupChat> GroupChats { get; set; }

    private View CurrentView { get; set; } = View.Friends;

    private Dictionary<View, IViewDelegate> Views { get; } = new()
    {
        {View.Friends, new CompFriendsView()},
        {View.Dm, new CompChatView()},
        {View.Group, new CompChatView()}
    };

    protected override async Task OnInitializedAsync()
    {
        await using var db = await Db.CreateDbContextAsync();
        Self = db.Users.Include(i => i.Chats).ThenInclude(c => c.Users).First();
        GroupChats = Self.Chats.OfType<GroupChat>().ToList();
        DmChats = Self.Chats.Except(GroupChats).Select(chat => new DmChat(chat, chat.Users.First(u => u.ID != Self.ID))).ToList();
    }

    private void ChangeView(View view, Chat? chat = null)
    {
        CurrentView = view;
        if (CurrentView.HasFlag(View.Chat))
        {
            (Views[CurrentView] as CompChatView)!.Chat = chat!;
        }
    }

    [Flags]
    private enum View
    {
        Dm = 0b0001,
        Group = 0b0010,
        Friends = 0b0100,
        Chat = Dm | Group
    }

    private record DmChat(Chat DbReference, User User);
}